<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!--    <link rel="stylesheet" href="/css/bootstrap.min.css">-->
    <link rel="stylesheet" href="/css/homeStyle.css">
    <link rel="stylesheet" href="/css/bodyHeader.css">

    <title>아주키노</title>

</head>

<script th:src="@{'/js/search.js'}"></script>

<body>
<div th:replace="fragments/bodyHeader :: bodyHeader" />
<div class="container">
    <div class="jumbotron">
        <!--        <a th:href="@{/oauth2/authorization/google}" class="btn btn-primary me-2 active" role="button">Google Login</a>-->

        <div th:if="${#authentication.name == 'anonymousUser'}">
            <h3>로그인 되어있지 않습니다!</h3>
        </div>
        <div th:if="${#authentication.name != 'anonymousUser'}">
            <h3>[[${#authentication.name}]]님 환영합니다!</h3>
            <!--            <a th:href="@{'/info/' + ${#authentication.name}}" class="btn btn-primary">유저 정보</a>-->
        </div>

        <div class="sections">
            <div class="section">
                <h3>이번 주 평가왕 <i class="fas fa-question-circle info-icon" data-info-key="weeklyRatingKing"></i></h3>
                <ul>
                    <li th:each="user : ${ratingKings}">
                        <div>
                            <a th:href="@{'/info/' + ${user.userCommonDTO.email}}">
                                <img th:src="${user.userCommonDTO.picture}" alt="User Picture" class="user-picture">
                            </a>
                            <strong th:text="${user.userCommonDTO.nickname}"
                                    th:style="'color: ' + ${user.userCommonDTO.role.color}"></strong>
                            <!--                    <span th:text="' (' + ${user.userCommonDTO.email} + ')'"></span>-->
                        </div>
                        <div>
                            <span th:text="'평가 수: ' + ${user.weeklyRatingCount}"></span>
                            <!--                    <span th:text="'리뷰 수: ' + ${user.weeklyReviewCount}"></span>-->
                        </div>
                    </li>
                </ul>
            </div>

            <div class="section">
                <h3>이번 주 리뷰왕 <i class="fas fa-question-circle info-icon" data-info-key="weeklyReviewKing"></i></h3>
                <ul>
                    <li th:each="user : ${reviewKings}">
                        <div>
                            <a th:href="@{'/info/' + ${user.userCommonDTO.email}}">
                                <img th:src="${user.userCommonDTO.picture}" alt="User Picture" class="user-picture">
                            </a>
                            <strong th:text="${user.userCommonDTO.nickname}"
                                    th:style="'color: ' + ${user.userCommonDTO.role.color}"></strong>
                            <!--                    <span th:text="' (' + ${user.userCommonDTO.email} + ')'"></span>-->
                        </div>
                        <div>
                            <!--                    <span th:text="'평가 수: ' + ${user.weeklyRatingCount}"></span>-->
                            <span th:text="'리뷰 수: ' + ${user.weeklyReviewCount}"></span>
                        </div>
                    </li>
                </ul>
            </div>

            <div class="section">
                <div>
                    <p>유저 수: <span id="userCount">0</span></p>
                    <p>총 평점 수: <span id="totalRatings">0</span></p>
                    <p>총 리뷰 수: <span id="totalReviews">0</span></p>
                </div>
            </div>
        </div>

        <div class="popular-container">
            <div class="reviews-header">
                <h2>인기 리뷰 <i class="fas fa-question-circle info-icon" data-info-key="popularReviews"></i></h2>
                <div>
                    <button class="btn btn-secondary" id="refreshReviewsBtn">새로고침</button>
                    <button class="btn btn-primary" id="viewAllBtn">전체 보기</button>
                </div>
            </div>
            <div class="reviews-container">
                <button class="arrow left">&#9664;</button>
                <div id="popularReviews" class="popular-reviews" style="overflow-x: auto; white-space: nowrap;">
                    <!-- 리뷰 카드들이 여기에 추가될 예정 -->
                </div>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>




        <div class="movie-category">
            <h2 class="category-title">오늘 아주대의 인기 영화 <i class="fas fa-question-circle info-icon" data-info-key="ajouPopular"></i></h2>
            <div class="movie-list-container">
                <button class="arrow left">&#9664;</button>
                <ul class="movie-list" id="ajouPopularList" style="overflow-x: auto; white-space: nowrap;">
                    <!-- 오늘 아주대의 인기 영화 동적으로 보여주기 -->
                </ul>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>

        <div th:if="${#authentication.name != 'anonymousUser'}">
            <div class="movie-category">
                <h2 class="category-title">나와 같은 mbti 사용자의 선호 영화 <i class="fas fa-question-circle info-icon" data-info-key="mbtiMovie"></i></h2>
                <div class="movie-list-container">
                    <button class="arrow left">&#9664;</button>
                    <ul class="movie-list" id="mbtiMovieList" style="overflow-x: auto; white-space: nowrap;">
                        <!-- 현재 로그인한 사용자의 mbti와 똑같은 다른 사용자의 선호 영화 동적으로 보여주기 -->
                    </ul>
                    <button class="arrow right">&#9654;</button>
                </div>
            </div>
        </div>


        <div class="movie-category" th:if="${dBOM}">
            <h2 class="category-title">일별 박스오피스 <i class="fas fa-question-circle info-icon" data-info-key="dailyBoxOffice"></i></h2>
            <div class="movie-list-container">
                <button class="arrow left">&#9664;</button>
                <ul class="movie-list" id="dBOMList" style="overflow-x: auto; white-space: nowrap;">
<!--                    일별 박스오피스 동적 생성-->
                </ul>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>

        <div class="movie-category" th:if="${wBOM}">
            <h2 class="category-title">주간 박스오피스 <i class="fas fa-question-circle info-icon" data-info-key="weeklyBoxOffice"></i></h2>
            <div class="movie-list-container">
                <button class="arrow left">&#9664;</button>
                <ul class="movie-list" id="wBOMList" style="overflow-x: auto; white-space: nowrap;">
<!--                    주간 박스오피스 동적 생성-->
                </ul>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>

        <div class="movie-category" th:if="${popularMovies}">
            <h2 class="category-title">인기 영화 <i class="fas fa-question-circle info-icon" data-info-key="popularMovies"></i></h2>
            <div class="movie-list-container">
                <button class="arrow left" >&#9664;</button>
                <ul class="movie-list" id="popularMovieList" style="overflow-x: auto; white-space: nowrap;">
<!--                    tmdb 인기 영화 동적 생성-->
                </ul>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>

        <div class="movie-category" th:if="${trendingMovies}">
            <h2 class="category-title">트렌딩 영화 <i class="fas fa-question-circle info-icon" data-info-key="trendingMovies"></i></h2>
            <div class="movie-list-container">
                <button class="arrow left" >&#9664;</button>
                <ul class="movie-list" id="trendingMovieList" style="overflow-x: auto; white-space: nowrap;">
<!--                    tmdb 트렌딩 영화 동적 생성-->
                </ul>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>


    </div>
    <div th:replace="fragments/footer :: footer" />
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
    let currentIndex;

    /*<![CDATA[*/
    const infoTexts = {
        weeklyRatingKing: "지난 7일 동안 가장 많은 평가를 남긴 사용자입니다. \n평가 수에 따라 선정되며, 매주 월요일 오전 1시에 갱신됩니다.",
        weeklyReviewKing: "지난 7일 동안 가장 많은 영화 리뷰를 작성한 사용자입니다. 리뷰 수에 따라 선정되며, 매주 월요일 오전 1시에 갱신됩니다.",
        popularReviews: "리뷰의 작성 시간과 좋아요 수를 종합적으로 고려하여 선정됩니다.",
        dailyBoxOffice: "전날의 영화관 관객 수를 기준으로 집계된 순위입니다. 매일 오전 9시경 전일자 데이터로 업데이트됩니다.",
        weeklyBoxOffice: "지난 주 영화관 관객 수를 기준으로 집계된 순위입니다. 매주 월요일 오전 9시경 전주 데이터로 업데이트됩니다.",
        popularMovies: "TMDB api를 통해 가져온 인기 영화들입니다. 평점, 리뷰 수, 조회수 등을 종합적으로 고려하여 선정됩니다.",
        trendingMovies: "TMDB api를 통해 가져온 최근 급상승하고 있는 영화들입니다. 최근 평점과 리뷰의 증가율, 조회수 변화 등을 바탕으로 선정됩니다.",
        ajouPopular: "하루 동안 사용자의 찜, 평가, 리뷰 작성 등의 활동 내역을 바탕으로 선정됩니다.",
        mbtiMovie: "사용자와 동일한 mbti를 가진 사용자의 선호 영화들입니다."
    };

    var dBOM = /*[[${dBOM}]]*/ '[]';
    var wBOM = /*[[${wBOM}]]*/ '[]';
    var popularMovies = /*[[${popularMovies}]]*/ '[]';
    var trendingMovies = /*[[${trendingMovies}]]*/ '[]';
    /*]]>*/

    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        getRealTimeData();
        setInterval(getRealTimeData, 60000);
        initializeInfoIcons();
        loadHomeReviews();
        loadAjouPopularMovies();
        loadMbtiPreferMovies();

        initializeMovieLists(dBOM, wBOM, popularMovies, trendingMovies);
        initializeMovieSmoothScrolls();
        initializeReviewSmoothScroll();

        document.getElementById('viewAllBtn').addEventListener('click', () => window.location.href = '/reviews?filter=popular');
        document.getElementById('refreshReviewsBtn').addEventListener('click', refreshReviews);
    }

    function initializeMovieSmoothScrolls() {
        const movieLists = ['dBOMList', 'wBOMList', 'popularMovieList', 'trendingMovieList', 'ajouPopularList', 'mbtiMovieList'];
        movieLists.forEach(listId => {
            initializeSmoothScroll(listId, 5);
        });
    }

    function initializeReviewSmoothScroll() {
        initializeSmoothScroll('popularReviews', 3);
    }

    function loadAjouPopularMovies() {
        fetch(`/api/home/ajouPopularMovies`)
            .then(response => response.json())
            .then(movies => {
                if (movies.length > 0) {
                    createMovieList(movies, 'ajouPopularList', 'ajouPop');
                    document.querySelector('.movie-category').style.display = 'block'; // div를 보이게 함
                } else {
                    document.querySelector('.movie-category').style.display = 'none'; // div를 보이게 함
                }
            })
            .catch(error => console.error('Error fetching user preferences:', error));
    }

    function loadMbtiPreferMovies() {
        if (!document.getElementById('mbtiMovieList')) return;

        fetch(`/api/home/mbtiMovies`)
            .then(response => response.json())
            .then(movies => {
                createMovieList(movies, 'mbtiMovieList', 'mbtiMovie');
            })
            .catch(error => console.error('Error fetching user preferences:', error));
    }

    function initializeInfoIcons() {
        const infoIcons = document.querySelectorAll('.info-icon');

        infoIcons.forEach(icon => {
            const infoKey = icon.getAttribute('data-info-key');
            const tooltipText = infoTexts[infoKey] || "정보가 없습니다.";
            const tooltip = document.createElement('span');
            tooltip.className = 'info-tooltip';
            tooltip.textContent = tooltipText;
            icon.appendChild(tooltip);

            icon.addEventListener('mouseenter', () => {
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
            })

            icon.addEventListener('mouseleave', () => {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            });
        });
    }

    function loadHomeReviews() {
        fetch('/api/reviews/home-reviews')
            .then(response => response.json())
            .then(reviews => {
                const container = document.getElementById('popularReviews');
                container.innerHTML = ''; // Clear existing reviews

                reviews.forEach((review) => {
                    const reviewElement = createReviewCard(review);
                    container.appendChild(reviewElement);
                });
            });
        initializeSmoothScroll('popularReviews', 3);
    }

    function refreshReviews() {
        fetch('/api/reviews/refresh-cache', {method: 'POST' })
            .then(() => {
                loadHomeReviews();
            });
    }

     function createReviewCard(review) {
        const reviewElement = document.createElement('div');
        reviewElement.className = 'review-card';
        reviewElement.setAttribute('data-review-id', review.reviewDTO.review.id);
        reviewElement.setAttribute('data-filter', review.filter);
        const rating = review.reviewDTO.userRating ? review.reviewDTO.userRating.toFixed(1) : '평가 없음';

        const reviewTextWithBreaks = review.reviewDTO.review.text.replace(/\n/g, '<br>');
        const userRoleClass = review.reviewDTO.user.role;

        reviewElement.innerHTML = `
            <div class="review-header">
                <div class="user-info">
                    <img src="${review.reviewDTO.user.picture}" alt="${review.reviewDTO.user.nickname}" class="user-picture">
                    <span class="user-nickname ${userRoleClass}">${review.reviewDTO.user.nickname}</span>
                </div>
                <div class="user-rating-container">
                    <span class="user-rating">평점: ${rating}</span>
                </div>

            </div>
            <div class="review-content">
                <img src="https://image.tmdb.org/t/p/w500${review.movieCommonDTO.poster_path}" alt="${review.movieCommonDTO.title}" class="review-poster">
                <h4>${review.movieCommonDTO.title}</h4>
                <p class="review-text">${reviewTextWithBreaks}</p>
            </div>
            <div class="review-footer">
                <small>좋아요: ${review.reviewDTO.heartCnt}</small>
            </div>
        `;

        reviewElement.addEventListener('click', function() {
            const reviewId = this.getAttribute('data-review-id');
            const filter = this.getAttribute('data-filter');
            goToReview(reviewId, filter);
        });

        return reviewElement;
    }


    function initializeMovieLists(dBOMJson, wBOMJson, popularMoviesJson, trendingMoviesJson) {
        try {
            var dBOM = JSON.parse(dBOMJson);
            var wBOM = JSON.parse(wBOMJson);
            var popularMovies = JSON.parse(popularMoviesJson);
            var trendingMovies = JSON.parse(trendingMoviesJson);

            if (Array.isArray(dBOM) && dBOM.length > 0) { createMovieList(dBOM, 'dBOMList', 'kobis'); }
            else { console.log('dBOM 조건문 통과 실패:', dBOM); }

            if (Array.isArray(wBOM) && wBOM.length > 0) { createMovieList(wBOM, 'wBOMList', 'kobis'); }
            else { console.log('wBOM 조건문 통과 실패:', wBOM); }

            if (popularMovies && popularMovies.results) { createMovieList(popularMovies.results, 'popularMovieList', 'tmdb'); }
            if (trendingMovies && trendingMovies.results) { createMovieList(trendingMovies.results, 'trendingMovieList', 'tmdb'); }
        } catch (error) {
            console.error('Error initializing movie lists:', error);
        }
    }

    // 영화 리스트 생성 함수 통합
    function createMovieList(movies, containerId, type) {
        const movieListContainer = document.getElementById(containerId);
        movieListContainer.innerHTML = '';

        movies.forEach((movie, index) => {
            const movieItem = document.createElement('li');
            movieItem.classList.add('movie-item');

            const poster = document.createElement('img');
            poster.src = `https://image.tmdb.org/t/p/w500${movie.poster_path}`;
            poster.alt = movie.title;
            poster.classList.add('movie-poster');
            poster.addEventListener('click', () => navigateToMovieDetails(type === 'kobis' ? movie.tmdbId : movie.id));

            poster.addEventListener('click', () => {
                const movieId = type === 'mbtiMovie' ? movie.tid : (type === 'kobis' ? movie.tmdbId : movie.id);
                navigateToMovieDetails(movieId);
            });


            const title = document.createElement('p');
            title.textContent = movie.title;
            title.classList.add('movie-title');

            movieItem.appendChild(poster);
            movieItem.appendChild(title);

            if (type === 'kobis') {
                const rank = document.createElement('div');
                rank.classList.add('movie-rank');
                rank.textContent = movie.rank;

                const audiAcc = document.createElement('p');
                audiAcc.classList.add('movie-info');
                audiAcc.innerHTML = `누적 관객<br>${formatNumber(movie.audiAcc)}명`;

                movieItem.appendChild(rank);
                movieItem.appendChild(audiAcc);
            }

            movieListContainer.appendChild(movieItem);
        });
        initializeSmoothScroll(containerId, 5);
    }

    function initializeSmoothScroll(containerId, itemsPerPage) {
        const container = document.getElementById(containerId);
        const leftArrow = container.parentElement.querySelector('.arrow.left');
        const rightArrow = container.parentElement.querySelector('.arrow.right');

        function scroll(direction) {
            const itemWidth = container.querySelector('.movie-item, .review-card').offsetWidth;
            const gap = 20; // gap between items
            const scrollAmount = (itemWidth + gap) * itemsPerPage * direction;
            container.scrollBy({
                left: scrollAmount,
                behavior: 'smooth'
            });
        }

        leftArrow.onclick = () => scroll(-1);
        rightArrow.onclick = () => scroll(1);

        // 스크롤 이벤트 리스너 추가
        container.addEventListener('scroll', () => {
            leftArrow.style.visibility = container.scrollLeft > 0 ? 'visible' : 'hidden';
            rightArrow.style.visibility =
                (container.scrollLeft + container.clientWidth < container.scrollWidth) ? 'visible' : 'hidden';
        });

        // 초기 화살표 상태 설정
        leftArrow.style.visibility = 'hidden';
        rightArrow.style.visibility =
            (container.scrollWidth > container.clientWidth) ? 'visible' : 'hidden';
    }


    function formatNumber(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function scrollContainer(containerId, direction) {
        const container = document.getElementById(containerId);
        const scrollAmount = container.clientWidth;
        container.scrollBy({
            left: direction * scrollAmount,
            behavior: 'smooth'
        });
    }

    function animateValue(id, start, end, duration) {
        start = parseInt(start) || 0;
        end = parseInt(end) || 0;
        if (start === end) {
            document.getElementById(id).innerHTML = end;
            return;
        }
        let current = start;
        const range = end - start;
        const increment = range / (duration / 16);  // 60 FPS를 가정
        const obj = document.getElementById(id);

        const timer = setInterval(function() {
            current += increment;
            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                clearInterval(timer);
                current = end;
            }
            obj.innerHTML = Math.round(current);
        }, 16);
    }

    function updateRealTimeData(data) {
        console.log('Received data:', data);  // 데이터 로깅
        if (data && typeof data === 'object') {
            animateValue('userCount', $('#userCount').text(), data.userCount || 0, 1000);
            animateValue('totalRatings', $('#totalRatings').text(), data.totalRatings || 0, 1000);
            animateValue('totalReviews', $('#totalReviews').text(), data.totalReviews || 0, 1000);
        } else {
            console.error('Invalid data received:', data);
        }
    }

    function getRealTimeData() {
        $.ajax({
            url: '/api/home/realtime-data',
            method: 'GET',
            success: updateRealTimeData,
            error: function(jqXHR, textStatus, errorThrown) {
                console.error('Error fetching real-time data:', textStatus, errorThrown);
            }
        });
    }

    function goToReview(reviewId, filter) {
        window.location.href = `/reviews?filter=${filter}&highlight=${reviewId}#review-${reviewId}`;
    }

    function navigateToMovieDetails(movieId) {
        window.location.href = '/contents/' + movieId;
    }

</script>
</body>
</html>