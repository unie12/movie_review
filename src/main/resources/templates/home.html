<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!--    <link rel="stylesheet" href="/css/bootstrap.min.css">-->
    <link rel="stylesheet" href="/css/homeStyle.css">
    <link rel="stylesheet" href="/css/bodyHeader.css">
    <link rel="stylesheet" href="/css/loading.css">

    <title>아주키노</title>

</head>

<script th:src="@{'/js/search.js'}"></script>

<body>
<script src="/js/loading.js"></script>
<script>
    LoadingManager.show();

    window.addEventListener('load', function() {
        LoadingManager.waitForImages().then(() => {
            LoadingManager.hide();
            document.getElementById('movie-content').style.display = 'block';
            initializePageContent();
        });
    });
</script>

<div th:replace="fragments/bodyHeader :: bodyHeader" />
<div class="container">
    <div class="jumbotron">

        <div class="sections">

            <div class="section">
                <div class="data-section">
                    <p class="week-title">이번 주 평가왕 <i class="fas fa-question-circle info-icon" data-info-key="weeklyRatingKing"></i></p>
                    <div id="ratingKingChart" class="king-chart"></div>
                </div>
            </div>

            <div class="section">
                <div class="data-section">
                    <p class="week-title">이번 주 리뷰왕 <i class="fas fa-question-circle info-icon" data-info-key="weeklyReviewKing"></i></p>
                    <div id="reviewKingChart" class="king-chart"></div>
                </div>
            </div>

            <div class="section">
                <div class="data-header">
                    <p>전체 유저: <span id="userCount">0개</span></p>
                    <p>전체 리뷰: <span id="totalReviews">0개</span></p>
                    <p>전체 평점: <span id="totalRatings">0개</span></p>
                </div>
                <div id="ratingDistribution" class="rating-distribution">
                    <!-- 전체 사용자들의 평가 분포 보여주기-->
                </div>
            </div>
        </div>

        <div class="popular-container">
            <div class="reviews-header">
                <p class="category-title">인기 리뷰 <i class="fas fa-question-circle info-icon" data-info-key="popularReviews"></i></p>
                <div>
                    <button class="btn btn-secondary" id="refreshReviewsBtn">새로고침</button>
                    <button class="btn btn-primary" id="viewAllBtn">전체 보기</button>
                </div>
            </div>
            <div class="reviews-container">
                <button class="arrow left">&#9664;</button>
                <button class="arrow right">&#9654;</button>
                <div id="popularReviews" class="popular-reviews">
                    <!-- 리뷰 카드들이 여기에 추가될 예정 -->
                </div>
            </div>
        </div>



        <div class="movie-category">
            <p class="category-title">오늘 아주대의 인기 영화 <i class="fas fa-question-circle info-icon" data-info-key="ajouPopular"></i></p>
            <div class="movie-list-container">
                <button class="arrow left">&#9664;</button>
                <ul class="movie-list" id="ajouPopularList">
                    <!-- 오늘 아주대의 인기 영화 동적으로 보여주기 -->
                </ul>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>

        <div th:if="${#authentication.name != 'anonymousUser'}">
            <div class="movie-category">
                <p class="category-title">나와 같은 mbti 사용자의 선호 영화 <i class="fas fa-question-circle info-icon" data-info-key="mbtiMovie"></i></p>
                <div class="movie-list-container">
                    <button class="arrow left">&#9664;</button>
                    <ul class="movie-list" id="mbtiMovieList">
                        <!-- 현재 로그인한 사용자의 mbti와 똑같은 다른 사용자의 선호 영화 동적으로 보여주기 -->
                    </ul>
                    <button class="arrow right">&#9654;</button>
                </div>
            </div>
        </div>


        <div class="movie-category" th:if="${dailyHome.dailyBoxOffice}">
            <p class="category-title">일별 박스오피스 <i class="fas fa-question-circle info-icon" data-info-key="dailyBoxOffice"></i></p>
            <div class="movie-list-container">
                <button class="arrow left">&#9664;</button>
                <ul class="movie-list" id="dBOMList">
<!--                    일별 박스오피스 동적 생성-->
                </ul>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>

        <div class="movie-category" th:if="${weeklyHome.weeklyBoxOffice}">
            <p class="category-title">주간 박스오피스 <i class="fas fa-question-circle info-icon" data-info-key="weeklyBoxOffice"></i></p>
            <div class="movie-list-container">
                <button class="arrow left">&#9664;</button>
                <ul class="movie-list" id="wBOMList">
<!--                    주간 박스오피스 동적 생성-->
                </ul>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>

        <div class="movie-category" th:if="${dailyHome.tmdbPopular}">
            <p class="category-title">인기 영화 <i class="fas fa-question-circle info-icon" data-info-key="popularMovies"></i></p>
            <div class="movie-list-container">
                <button class="arrow left" >&#9664;</button>
                <ul class="movie-list" id="popularMovieList">
<!--                    tmdb 인기 영화 동적 생성-->
                </ul>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>

        <div class="movie-category" th:if="${dailyHome.tmdbTrend}">
            <p class="category-title">트렌딩 영화 <i class="fas fa-question-circle info-icon" data-info-key="trendingMovies"></i></p>
            <div class="movie-list-container">
                <button class="arrow left" >&#9664;</button>
                <ul class="movie-list" id="trendingMovieList">
<!--                    tmdb 트렌딩 영화 동적 생성-->
                </ul>
                <button class="arrow right">&#9654;</button>
            </div>
        </div>


    </div>
    <div th:replace="fragments/footer :: footer" />
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
    let currentIndex;

    /*<![CDATA[*/
    const infoTexts = {
        weeklyRatingKing: "지난 7일 동안 가장 많은 평가를 남긴 사용자입니다. \n평가 수에 따라 선정되며, 매주 월요일 오전 1시에 갱신됩니다.",
        weeklyReviewKing: "지난 7일 동안 가장 많은 영화 리뷰를 작성한 사용자입니다. 리뷰 수에 따라 선정되며, 매주 월요일 오전 1시에 갱신됩니다.",
        popularReviews: "리뷰의 작성 시간과 좋아요 수를 종합적으로 고려하여 선정됩니다.",
        dailyBoxOffice: "전날의 영화관 관객 수를 기준으로 집계된 순위입니다. 매일 오전 9시경 전일자 데이터로 업데이트됩니다.",
        weeklyBoxOffice: "지난 주 영화관 관객 수를 기준으로 집계된 순위입니다. 매주 월요일 오전 9시경 전주 데이터로 업데이트됩니다.",
        popularMovies: "TMDB api를 통해 가져온 인기 영화들입니다. 평점, 리뷰 수, 조회수 등을 종합적으로 고려하여 선정됩니다.",
        trendingMovies: "TMDB api를 통해 가져온 최근 급상승하고 있는 영화들입니다. 최근 평점과 리뷰의 증가율, 조회수 변화 등을 바탕으로 선정됩니다.",
        ajouPopular: "하루 동안 사용자의 찜, 평가, 리뷰 작성 등의 활동 내역을 바탕으로 선정됩니다.",
        mbtiMovie: "사용자와 동일한 mbti를 가진 사용자의 선호 영화들입니다."
    };

    var dailyHome = /*[[${dailyHome}]]*/ null;
    var weeklyHome = /*[[${weeklyHome}]]*/ null;
    /*]]>*/

    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        getRealTimeData();
        setInterval(getRealTimeData, 60000);
        initializeInfoIcons();
        renderKingCharts();

        loadHomeReviews();
        loadAjouPopularMovies();
        loadMbtiPreferMovies();

        initializeMovieLists(dailyHome, weeklyHome);

        initializeMovieSmoothScrolls();
        initializeReviewSmoothScroll();

        document.getElementById('viewAllBtn').addEventListener('click', () => window.location.href = '/reviews?filter=popular');
        document.getElementById('refreshReviewsBtn').addEventListener('click', refreshReviews);
    }

    function initializeMovieSmoothScrolls() {
        const movieLists = ['dBOMList', 'wBOMList', 'popularMovieList', 'trendingMovieList', 'ajouPopularList', 'mbtiMovieList'];
        movieLists.forEach(listId => {
            initializeSmoothScroll(listId, '.movie-item');
        });
    }

    function initializeReviewSmoothScroll() {
        initializeSmoothScroll('popularReviews', '.review-card');
    }

    function loadAjouPopularMovies() {
        fetch(`/api/home/ajouPopularMovies`)
            .then(response => response.json())
            .then(movies => {
                if (movies.length > 0) {
                    createMovieList(movies, 'ajouPopularList', 'ajouPop');
                    document.querySelector('.movie-category').style.display = 'block'; // div를 보이게 함
                    initializeSmoothScroll('ajouPopularList', '.movie-item');

                } else {
                    document.querySelector('.movie-category').style.display = 'none'; // div를 보이게 함
                }
            })
            .catch(error => console.error('Error fetching user preferences:', error));
    }

    function loadMbtiPreferMovies() {
        const mbtiMovieContainer = document.querySelector('.movie-category:has(#mbtiMovieList)');
        if (!document.getElementById('mbtiMovieList')) return;

        fetch(`/api/home/mbtiMovies`)
            .then(response => response.json())
            .then(movies => {
                if (movies.length > 0) {
                    createMovieList(movies, 'mbtiMovieList', 'mbtiMovie');
                    initializeSmoothScroll('mbtiMovieList', '.movie-item');
                    mbtiMovieContainer.style.display = 'block'; // 영화가 있으면 보이게 함
                } else {
                    document.querySelector('.movie-category').style.display = 'none'; // div를 보이게 함
                    mbtiMovieContainer.style.display = 'none'; // 영화가 있으면 보이게 함
                }
            })
            .catch(error => {
                console.error('Error fetching user preferences:', error);
                mbtiMovieContainer.style.display = 'none'; // 에러 발생 시 숨김
            });
    }

    function initializeInfoIcons() {
        const infoIcons = document.querySelectorAll('.info-icon');

        infoIcons.forEach(icon => {
            const infoKey = icon.getAttribute('data-info-key');
            const tooltipText = infoTexts[infoKey] || "정보가 없습니다.";
            const tooltip = document.createElement('span');
            tooltip.className = 'info-tooltip';
            tooltip.textContent = tooltipText;
            icon.appendChild(tooltip);

            icon.addEventListener('mouseenter', () => {
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
            })

            icon.addEventListener('mouseleave', () => {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            });
        });
    }

    function renderKingCharts() {
        renderKingChart('ratingKingChart', weeklyHome.ratingKing, 'weeklyRatingCount');
        renderKingChart('reviewKingChart', weeklyHome.reviewKing, 'weeklyReviewCount');
    }

    function renderKingChart(containerId, data, countProperty) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      const maxCount = Math.max(...data.map(user => user[countProperty]));

      data.forEach((user, index) => {
        const barWrapper = document.createElement('div');
        barWrapper.className = 'king-bar-wrapper';

        const bar = document.createElement('div');
        bar.className = 'king-bar';
        const height = (user[countProperty] / maxCount) * 180;
        bar.style.height = '0px';  // 초기 높이를 0으로 설정
        bar.style.backgroundColor = user[countProperty] === maxCount ? '#ff4500' : '#007bff';
        bar.title = `${user[countProperty]}개`;


        const profile = document.createElement('div');
        profile.className = 'king-profile';
        profile.innerHTML = `
          <img src="${user.userCommonDTO.picture}" alt="${user.userCommonDTO.nickname}"
          onclick="navigateToUser('${user.userCommonDTO.email}')">
          <p style="color: ${user.userCommonDTO.role.color}">${user.userCommonDTO.nickname}</p>
        `;

        barWrapper.appendChild(bar);
        barWrapper.appendChild(profile);
        container.appendChild(barWrapper);

        // 애니메이션 적용
        setTimeout(() => {
          bar.style.height = `${height}px`;
          bar.style.animationPlayState = 'running';
        }, 50);
      });
    }

    function loadHomeReviews() {
        fetch('/api/reviews/home-reviews')
            .then(response => response.json())
            .then(reviews => {
                const container = document.getElementById('popularReviews');
                container.innerHTML = ''; // Clear existing reviews

                reviews.forEach((review) => {
                    const reviewElement = createReviewCard(review);
                    container.appendChild(reviewElement);
                    initializeSmoothScroll('popularReviews', '.review-card');
                });
            });
    }

    function refreshReviews() {
        fetch('/api/reviews/refresh-cache', {method: 'POST' })
            .then(() => {
                loadHomeReviews();
                initializeSmoothScroll('popularReviews', '.review-card');

            });
    }

     function createReviewCard(review) {
        const reviewElement = document.createElement('div');
        reviewElement.className = 'review-card';
        reviewElement.setAttribute('data-review-id', review.reviewDTO.review.id);
        reviewElement.setAttribute('data-filter', review.filter);
        const rating = review.reviewDTO.userRating ? review.reviewDTO.userRating.toFixed(1) : '평가 없음';

        const reviewTextWithBreaks = review.reviewDTO.review.text.replace(/\n/g, '<br>');
        const userRoleClass = review.reviewDTO.user.role;
        const posterUrl = getImageUrl(review.movieCommonDTO.poster_path, '/images/defaultMovie.png');

        reviewElement.innerHTML = `
            <div class="review-header">
                <div class="user-info">
                    <img src="${review.reviewDTO.user.picture}" alt="${review.reviewDTO.user.nickname}" class="user-picture">
                    <span class="user-nickname ${userRoleClass}">${review.reviewDTO.user.nickname}</span>
                </div>
                <div class="user-rating-container">
                    <span class="user-rating">평점: ${rating}</span>
                </div>

            </div>
            <div class="review-content">
                <img src="${posterUrl}" alt="${review.movieCommonDTO.title}" class="review-poster">
                <p class="movie-title">${review.movieCommonDTO.title}</p>
                <p class="review-text">${reviewTextWithBreaks}</p>
            </div>
            <div class="review-footer">
                <small>좋아요: ${review.reviewDTO.heartCnt}</small>
            </div>
        `;

        reviewElement.addEventListener('click', function() {
            const reviewId = this.getAttribute('data-review-id');
            const filter = this.getAttribute('data-filter');
            goToReview(reviewId, filter);
        });

        return reviewElement;
    }


    function initializeMovieLists(dailyHome, weeklyHome) {
        try {
            if (dailyHome && dailyHome.dailyBoxOffice) { createMovieList(dailyHome.dailyBoxOffice, 'dBOMList', 'kobis'); }
            if (weeklyHome && weeklyHome.weeklyBoxOffice) { createMovieList(weeklyHome.weeklyBoxOffice, 'wBOMList', 'kobis'); }
            if (dailyHome && dailyHome.tmdbPopular) { createMovieList(dailyHome.tmdbPopular, 'popularMovieList', 'tmdb'); }
            if (dailyHome && dailyHome.tmdbTrend) { createMovieList(dailyHome.tmdbTrend, 'trendingMovieList', 'tmdb'); }
        } catch (error) {
            console.error('Error initializing movie lists:', error);
        }
    }

    function getImageUrl(path, defaultImage) {
        return path ? `https://image.tmdb.org/t/p/w500${path}` : defaultImage;
    }

    // 영화 리스트 생성 함수 통합
    function createMovieList(movies, containerId, type) {
        const movieListContainer = document.getElementById(containerId);
        movieListContainer.innerHTML = '';

        movies.forEach((movie, index) => {
            const movieItem = document.createElement('li');
            movieItem.classList.add('movie-item');

            const poster = document.createElement('img');
            poster.src = getImageUrl(movie.poster_path, '/images/defaultMovie.png');
            poster.alt = movie.title;
            poster.classList.add('movie-poster');
            poster.addEventListener('click', () => navigateToMovieDetails(type === 'kobis' ? movie.tmdbId : movie.id));

            poster.addEventListener('click', () => {
                const movieId = type === 'mbtiMovie' ? movie.tid : (type === 'kobis' ? movie.tmdbId : movie.id);
                navigateToMovieDetails(movieId);
            });


            const title = document.createElement('p');
            title.textContent = movie.title;
            title.classList.add('movie-title');

            movieItem.appendChild(poster);
            movieItem.appendChild(title);

            if (type === 'kobis') {
                const rank = document.createElement('div');
                rank.classList.add('movie-rank');
                rank.textContent = movie.rank;

                const audiAcc = document.createElement('p');
                audiAcc.classList.add('movie-info');
                audiAcc.innerHTML = `누적 관객 ${formatNumber(movie.audiAcc)}명`;

                movieItem.appendChild(rank);
                movieItem.appendChild(audiAcc);
            }

            movieListContainer.appendChild(movieItem);
        });
    }

    function initializeSmoothScroll(containerId, itemsPerPageSelector) {
        const container = document.getElementById(containerId);
        const leftArrow = container.parentElement.querySelector('.arrow.left');
        const rightArrow = container.parentElement.querySelector('.arrow.right');

        function getItemsPerPage() {
            // 화면 너비에 따라 아이템 수 결정
            if (window.innerWidth < 768) return 2;
            if (window.innerWidth < 1024) return 3;
            return 5;
        }

        function updateArrowVisibility() {
            // 브라우저의 다음 렌더링 사이클에서 계산 수행
            requestAnimationFrame(() => {
                const scrollLeft = container.scrollLeft;
                const scrollWidth = container.scrollWidth;
                const clientWidth = container.clientWidth;

                leftArrow.style.visibility = scrollLeft > 0 ? 'visible' : 'hidden';
                rightArrow.style.visibility =
                    Math.ceil(scrollLeft + clientWidth) < scrollWidth - 1 ? 'visible' : 'hidden';
                    // 부동소수점 오차 고려 (-1)
            });
        }

        function scroll(direction) {
            const itemWidth = container.querySelector(itemsPerPageSelector).offsetWidth;
            const gap = 20; // gap between items
            const itemsPerPage = getItemsPerPage();
            const scrollAmount = (itemWidth + gap) * itemsPerPage * direction;
            container.scrollBy({
                left: scrollAmount,
                behavior: 'smooth'
            });
        }

        leftArrow.onclick = () => scroll(-1);
        rightArrow.onclick = () => scroll(1);

        // 스크롤 이벤트가 끝난 후에만 화살표 가시성 업데이트 -> 불필요한 계산 줄임
        let scrollTimeout;
        container.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateArrowVisibility, 100);
        });

        window.addEventListener('resize', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateArrowVisibility, 100);
        });

        // 초기 화살표 상태 설정
        updateArrowVisibility();
    }


    function formatNumber(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }


    function animateValue(id, start, end, duration) {
        start = parseInt(start) || 0;
        end = parseInt(end) || 0;
        if (start === end) {
            document.getElementById(id).innerHTML = end;
            return;
        }
        let current = start;
        const range = end - start;
        const increment = range / (duration / 16);  // 60 FPS를 가정
        const obj = document.getElementById(id);

        const timer = setInterval(function() {
            current += increment;
            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                clearInterval(timer);
                current = end;
            }
            obj.innerHTML = Math.round(current);
        }, 16);
    }

    function updateRealTimeData(data) {
        if (data && typeof data === 'object') {
            animateValue('userCount', $('#userCount').text(), data.userCount || 0, 800);
            animateValue('totalRatings', $('#totalRatings').text(), data.totalRatings || 0, 800);
            animateValue('totalReviews', $('#totalReviews').text(), data.totalReviews || 0, 800);
            renderRatingDistribution(data.ratingDistribution);
        } else {
            console.error('Invalid data received:', data);
        }
    }

    function getRealTimeData() {
        $.ajax({
            url: '/api/home/realtime-data',
            method: 'GET',
            success: updateRealTimeData,
            error: function(jqXHR, textStatus, errorThrown) {
                console.error('Error fetching real-time data:', textStatus, errorThrown);
            }
        });
    }

    function renderRatingDistribution(distribution) {
        const container = document.getElementById('ratingDistribution');
        container.innerHTML = '';

        const maxCount = Math.max(...Object.values(distribution));
        const barContainer = document.createElement('div');
        barContainer.className = 'bar-container';

        Object.entries(distribution).forEach(([rating, count]) => {
            const barWrapper = document.createElement('div');
            barWrapper.className = 'bar-wrapper';

            const bar = document.createElement('div');
            const height = count > 0 ? (count / maxCount) * 180 : 0;
            bar.className = 'bar';
            bar.style.setProperty('--target-height', `${height}px`);
            bar.style.backgroundColor = count === maxCount ? '#ff4500' : '#007bff';
            bar.title = `${count}개`;

            const ratingLabel = document.createElement('div');
            ratingLabel.className = 'rating-label';
            ratingLabel.textContent = rating;

            barWrapper.appendChild(bar);
            barWrapper.appendChild(ratingLabel);

            barContainer.appendChild(barWrapper);
        });
        container.appendChild(barContainer);

        // 애니메이션 시작을 위한 지연
        setTimeout(() => {
            barContainer.querySelectorAll('.bar').forEach(bar => {
                bar.style.animationPlayState = 'running';
            });
        }, 100);
    }

    function goToReview(reviewId, filter) {
        window.location.href = `/reviews?filter=${filter}&highlight=${reviewId}#review-${reviewId}`;
    }

    function navigateToMovieDetails(movieId) {
        window.location.href = '/contents/' + movieId;
    }

    function navigateToUser(email) {
        window.location.href = '/info/' + email;
    }

</script>
</body>
</html>