<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
<!--    <link rel="stylesheet" href="/css/bootstrap.min.css">-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="/css/bodyHeader.css">
    <style>
        .container {
            position: relative; /* container 요소에 position: relative; 추가 */
            padding: 10px 200px;
        }
        .user-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        .user-nickname {
            font-weight: bold;
            margin-right: 10px;
        }
        .life-movies {
            display: flex; /* Flexbox 사용 */
            flex-wrap: wrap; /* 줄바꿈 허용 */
            gap: 10px; /* 영화 간의 간격 */
        }
        .movie-element {
            width: 150px; /* 영화 요소의 너비 설정 */
            cursor: pointer; /* 마우스 커서 포인터로 변경 */
        }
        .movie-content {
            text-align: center; /* 영화 포스터 중앙 정렬 */
        }
        .movie-poster {
            width: 100%; /* 포스터가 요소의 너비에 맞게 조정 */
            height: auto; /* 비율 유지 */
        }

    </style>

    <title>사용자 활동 내역</title>
</head>
<script th:src="@{'/js/search.js'}"></script>

<body>
<div class="container">
    <div th:replace="fragments/bodyHeader :: bodyHeader"></div>

    <img th:src="${userDTO.userCommonDTO.picture}" alt="User Picture" class="user-picture">
    <span th:text="${userDTO.userCommonDTO.nickname}" class="user-nickname"
          th:style="'color: ' + ${userDTO.userCommonDTO.role.color}">
    </span>
    <button th:if="${#authentication.name != userDTO.userCommonDTO.email}"
            id="subscription"
            th:class="${isSubscribed ? 'btn btn-danger' : 'btn btn-secondary'}"
            th:text="${isSubscribed ? '구독 취소' : '구독'}"></button>

    <button th:if="${#authentication.name == userDTO.userCommonDTO.email}"  id="deleteAccount">회원 탈퇴</button>
    <!--    <button th:if="${#authentication.name == userDTO.userCommonDTO.email}"-->
<!--            th:text="${"-->
    <br>
    <div>
        <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/subscription'}">
            <span th:text="'내가 구독한 사용자 ' +${userDTO.subscriptionCnt}"></span>
        </a>
        <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/subscriber'}">
            <span th:text="'나를 구독한 사용자 ' + ${userDTO.subscriberCnt}"></span>
        </a>
    </div>
    <br>

    <h2>사용자 활동 내역</h2>

    <div>
        <h3 th:text="'즐겨찾기 영화 (' + ${userDTO.favoriteCnt} + '개)'"></h3>
        <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/favorite'}">즐겨찾기 영화 보기</a>
    </div>
    <br>

    <div>
        <h3 th:text="'리뷰 작성한 영화 (' + ${userDTO.reviewCnt} + '개)'"></h3>
        <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/review'}">리뷰 작성한 영화 보기</a>
    </div>
    <br>

    <div>
        <h3 th:text="'평점 매긴 영화 (' + ${userDTO.ratingCnt} + '개)'"></h3>
        <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/rating'}">평점 매긴 보기</a>
    </div>
    <br>

    <div>
        <h3 th:text="'좋아요 누른 리뷰 (' + ${userDTO.heartCnt} + '개)'"></h3>
        <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/heart'}">좋아요 누른 리뷰 보기</a>
    </div>
    <br>

    <!-- ~님의 인생 영화-->
    <div>
        <h3 th:text="${userDTO.userCommonDTO.nickname} + '님의 인생 영화'"></h3>
        <div id="lifeMovies" class="life-movies">
            <!-- 해당 사용자의 인생 영화 리스트 동적으로 보여주기 -->
        </div>
    </div>
<!--    ~님의 평가 분포-->
<!--    ~님과 나의 유사한 활동 내역 영화(좋은 평가, 찜 목록 겹)-->
<!--    ~님의 선호 키워드-->
<!--    ~님의 선호 감독, 배우, 장르-->
<!--    ~님과 나의 취향매칭률-->

</div>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let userEmail, currentUserEmail;
    $(document).ready(function() {
        const subscriptionBtn = $('#subscription');
        const deleteAccountBtn = $('#deleteAccount');
        userEmail = '[[${userDTO.userCommonDTO.email}]]';
        currentUserEmail = '[[${#authentication.name}]]';

        if( userEmail !== currentUserEmail) {
            checkSubscriptionStatus();
            subscriptionBtn.click(toggleSubscription);
        }

        deleteAccountBtn.click(confirmDeleteAccount);
        loadLifeMovies();
    });

    function checkSubscriptionStatus() {
        makeApiCall(`/api/user/subscription/${userEmail}`, 'GET', null, updateButtonState);
    }

    function toggleSubscription() {
        makeApiCall(`/api/user/subscription/${userEmail}`, 'PUT', null, updateButtonState);
    }

    function updateButtonState(response) {
        const isSubscribed = response.subscribed;
        $('#subscription').text(isSubscribed ? '구독 취소' : '구독')
            .removeClass(isSubscribed ? 'btn-secondary' : 'btn-danger')
            .addClass(isSubscribed ? 'btn-danger' : 'btn-secondary');
    }

    function confirmDeleteAccount() {
        if (confirm('회원 탈퇴를 진행한다면 해당 이메일의 모든 활동 내역은 사라지게 됩니다.')) {
            if (confirm('회원 탈퇴를 진행하시겠습니까?')) {
                makeApiCall(`/api/user/${currentUserEmail}/deleteAccount`, 'DELETE', null, handleDeleteAccountResponse);
            }
        }
    }

    function makeApiCall(url, method, data, successCallback) {
        $.ajax({
            url: url,
            type: method,
            data: data,
            contentType: 'application/json',
            success: successCallback,
            error: function(xhr, status, error) {
                console.error(`Error in ${method} request to ${url}:`, error);
            }
        });
    }

    function handleDeleteAccountResponse() {
        localStorage.removeItem('jwtToken');
        sessionStorage.clear();
        window.location.href = `/jwt-login`;
    }

    function loadLifeMovies() {
        fetch(`/api/user/${userEmail}/lifeMovies`)
            .then(response => response.json())
            .then(movies => {
                console.log('movies', movies);
                const container = document.getElementById('lifeMovies');
                container.innerHTML = '';

                if(movies.length === 0) {
                    container.innerHTML = '<p>인생영화를 아직 등록하지 않았습니다!</p>';
                } else {
                    movies.forEach((movie) => {
                        const movieElement = createMovieElement(movie);
                        container.appendChild(movieElement);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching life movies:', error);
                const container = document.getElementById('lifeMovies');
                container.innerHTML = '<p>인생영화를 불러오는 데 오류가 발생했습니다</p>';
            });
    }

    function createMovieElement(movie) {
        const movieElement = document.createElement('div');
        movieElement.className = 'movie-element';
        movieElement.setAttribute('data-movie-tid', movie.tid);

        movieElement.innerHTML = `
            <div class="movie-content">
                <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" class="movie-poster">
            </div>
        `;

        movieElement.addEventListener('click', function() {
            const movieTid = this.getAttribute('data-movie-tid');
            navigateToMovie(movieTid);
        });

        return movieElement;
    }

    function navigateToMovie(movieId) {
       window.location.href = '/contents/' + movieId;
    }
</script>