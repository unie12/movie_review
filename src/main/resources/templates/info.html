<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
<!--    <link rel="stylesheet" href="/css/bootstrap.min.css">-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="/css/bodyHeader.css">
    <link rel="stylesheet" href="/css/info.css">

    <title>사용자 활동 내역</title>
</head>
<script th:src="@{'/js/search.js'}"></script>

<body>
<div class="container">
    <div th:replace="fragments/bodyHeader :: bodyHeader"></div>

    <!-- 사용자 정보  -->
    <div class="user-info-box">
        <img th:src="${userDTO.userCommonDTO.picture}" alt="User Picture" class="user-picture">
        <span th:text="${userDTO.userCommonDTO.nickname}" class="user-nickname"
              th:style="'color: ' + ${userDTO.userCommonDTO.role.color}">
        </span>
        <button th:if="${#authentication.name != userDTO.userCommonDTO.email}"
                id="subscription"
                th:class="${isSubscribed ? 'btn btn-danger' : 'btn btn-secondary'}"
                th:text="${isSubscribed ? '구독 취소' : '구독'}"></button>
        <button th:if="${#authentication.name == userDTO.userCommonDTO.email}" id="deleteAccount">회원 탈퇴</button>
        <div class="subscription-info">
            <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/subscription'}">
                <span th:text="'내가 구독한 사용자 ' +${userDTO.subscriptionCnt}"></span>
            </a>
            <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/subscriber'}">
                <span th:text="'나를 구독한 사용자 ' + ${userDTO.subscriberCnt}"></span>
            </a>
        </div>
    </div>

    <!-- 사용자 활동 내역-->
    <div class="activity-box">
        <h2>사용자 활동 내역</h2>
        <div class="activity-item">
            <h3 th:text="'즐겨찾기 영화 (' + ${userDTO.favoriteCnt} + '개)'"></h3>
            <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/favorite'}">즐겨찾기 영화 보기</a>
        </div>
        <div class="activity-item">
            <h3 th:text="'리뷰 작성한 영화 (' + ${userDTO.reviewCnt} + '개)'"></h3>
            <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/review'}">리뷰 작성한 영화 보기</a>
        </div>
        <div class="activity-item">
            <h3 th:text="'평점 매긴 영화 (' + ${userDTO.ratingCnt} + '개)'"></h3>
            <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/rating'}">평점 매긴 보기</a>
        </div>
        <div class="activity-item">
            <h3 th:text="'좋아요 누른 리뷰 (' + ${userDTO.heartCnt} + '개)'"></h3>
            <a th:href="@{'/info/' + ${userDTO.userCommonDTO.email} + '/heart'}">좋아요 누른 리뷰 보기</a>
        </div>
    </div>

    <!-- 사용자 인생 영화-->
    <div class="life-movies-box">
        <h3 th:text="${userDTO.userCommonDTO.nickname} + '님의 인생 영화'"></h3>
        <div id="lifeMovies" class="life-movies">
            <!-- 해당 사용자의 인생 영화 리스트 동적으로 보여주기 -->
        </div>
    </div>

    <!-- 사용자 평가 분포-->
    <div class="rating-distribution-box">
        <h3 th:text="${userDTO.userCommonDTO.nickname} + '님의 평가 분포'"></h3>
        <div id="ratingDistribution" class="rating-distribution">
            <!-- 해당 사용자의 전체 평점 분포 동적으로 보여주기 -->
        </div>
    </div>

    <!-- 사용자 선호 키워드-->
    <div class="prefer-keyword-box">
        <h3 th:text="${userDTO.userCommonDTO.nickname} + '님의 선호 키워드'"></h3>
        <div id="keywordCloud" class="keyword-cloud">
            <!-- 해당 사용자의 전체 평점 분포 동적으로 보여주기 -->
        </div>
    </div>

    <!-- 사용자 선호 감독-->
    <div class="prefer-director-box">
        <h3 th:text="${userDTO.userCommonDTO.nickname} + '님의 선호 감독'"></h3>
        <div id="preferDirectors" class="prefer-person">
            <!-- 해당 사용자의 전체 평점 분포 동적으로 보여주기 -->
        </div>
    </div>

    <!-- 사용자 선호 배우-->
    <div class="prefer-actor-box">
        <h3 th:text="${userDTO.userCommonDTO.nickname} + '님의 선호 배우'"></h3>
        <div id="preferActors" class="prefer-person">
            <!-- 해당 사용자의 전체 평점 분포 동적으로 보여주기 -->
        </div>
    </div>
    <!-- 사용자 선호 장르-->

<!--    ~님과 나의 유사한 활동 내역 영화(좋은 평가, 찜 목록 겹)-->
<!--    ~님과 나의 취향매칭률-->

</div>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let userEmail, currentUserEmail;

    $(document).ready(function() {
        initializeUserInfo();
        initializeDataLoading();
    });

    function initializeUserInfo() {
        userEmail = '[[${userDTO.userCommonDTO.email}]]';
        currentUserEmail = '[[${#authentication.name}]]';

        if (userEmail !== currentUserEmail) {
            checkSubscriptionStatus();
            $('#subscription').click(toggleSubscription);
        }

        $('#deleteAccount').click(confirmDeleteAccount);
    }

    function initializeDataLoading() {
        loadData('lifeMovies', 'lifeMovies', renderLifeMovies);
        loadData('ratings', 'ratingDistribution', renderRatingDistribution);
        loadData('keywords', 'keywordCloud', renderKeywords);
        loadData('directors', 'preferDirectors', (data, container) => renderPeople(data, container, 'crew'));
        loadData('actors', 'preferActors', (data, container) => renderPeople(data, container, 'cast'));
    }

    function loadData(endpoint, containerId, renderFunction) {
        const container = document.getElementById(containerId);
        fetch(`/api/user/${userEmail}/${endpoint}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    container.innerHTML = '<p>더 많은 평가 데이터가 필요해요!</p>';
                } else {
                    renderFunction(data, container);
                }
            })
            .catch(error => {
                console.error(`Error fetching ${endpoint}:`, error);
                container.innerHTML = `<p>${endpoint}를 불러오는 데 오류가 발생했습니다</p>`;
            });
    }

    // 구독 확인
    function checkSubscriptionStatus() {
        makeApiCall(`/api/user/subscription/${userEmail}`, 'GET', null, updateButtonState);
    }

    // 구독 버튼 토글
    function toggleSubscription() {
        makeApiCall(`/api/user/subscription/${userEmail}`, 'PUT', null, updateButtonState);
    }

    // 구독 버튼 상태 변경
    function updateButtonState(response) {
        const isSubscribed = response.subscribed;
        $('#subscription').text(isSubscribed ? '구독 취소' : '구독')
            .removeClass(isSubscribed ? 'btn-secondary' : 'btn-danger')
            .addClass(isSubscribed ? 'btn-danger' : 'btn-secondary');
    }

    // 회원 탈퇴
    function confirmDeleteAccount() {
        if (confirm('회원 탈퇴를 진행한다면 해당 이메일의 모든 활동 내역은 사라지게 됩니다.')) {
            if (confirm('회원 탈퇴를 진행하시겠습니까?')) {
                makeApiCall(`/api/user/${currentUserEmail}/deleteAccount`, 'DELETE', null, handleDeleteAccountResponse);
            }
        }
    }

    // 탈퇴 후 로그인 인증 정보 삭제
    function handleDeleteAccountResponse() {
        localStorage.removeItem('jwtToken');
        sessionStorage.clear();
        window.location.href = `/jwt-login`;
    }


    // 인생 영화 리스트 토대로 포스터 보여주기
    function renderLifeMovies(movies, container) {
        container.innerHTML = '';

        movies.forEach((movie) => {
            const movieElement = document.createElement('div');
            movieElement.className = 'movie-element';
            movieElement.setAttribute('data-movie-tid', movie.tid);

            movieElement.innerHTML = `
                <div class="movie-content">
                    <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" class="movie-poster">
                </div>
            `;

            movieElement.addEventListener('click', function() {
                const movieTid = this.getAttribute('data-movie-tid');
                navigateToMovie(movieTid);
            });

            container.appendChild(movieElement);
        });
    }

    // 사용자 평가 분포 렌더링
    function renderRatingDistribution(ratings, container) {
        const distribution = calculateDistribution(ratings);
        container.innerHTML = '';

        const maxCount = Math.max(...Object.values(distribution));
        const barContainer = document.createElement('div');
        barContainer.className = 'bar-container';

        Object.entries(distribution).sort((a, b) => parseFloat(a[0]) - parseFloat(b[0])).forEach(([rating, count]) => {
            const barWrapper = document.createElement('div');
            barWrapper.className = 'bar-wrapper';

            const bar = document.createElement('div');
            const height = count > 0 ? (count / maxCount) * 180 : 0;
            bar.className = 'bar';
            bar.style.height = `${height}px`;
            bar.style.backgroundColor = count === maxCount ? '#ff4500' : '#007bff';
            bar.title = `${count}개`;

            const ratingLabel = document.createElement('div');
            ratingLabel.className = 'rating-label';
            ratingLabel.textContent = rating;

            barWrapper.appendChild(bar);
            barWrapper.appendChild(ratingLabel);

            barContainer.appendChild(barWrapper);
        });
        container.appendChild(barContainer);
    }

    // 사용자 평가 분포 계산
    function calculateDistribution(ratings) {
        const distribution = {0.5: 0, 1.0: 0, 1.5: 0, 2.0: 0, 2.5: 0, 3.0: 0, 3.5: 0, 4.0: 0, 4.5: 0, 5.0: 0};
        ratings.forEach(rating => {
            distribution[rating]++;
        });
        return distribution;
    }

    // 선호 감독 요소 만들기
    function renderPeople(people, container, type) {
        container.innerHTML = '';
        people.forEach(person => {
            const personElement = document.createElement('div');
            personElement.className = 'person-element';

            const imageUrl = person.profile_path
            ? `https://image.tmdb.org/t/p/w200${person.profile_path}`
            : '/images/defaultMovie.png'; // 기본 이미지 경로 설정

            personElement.innerHTML = `
                <div class="person-content">
                    <img src="${imageUrl}" alt="${person.name}" class="person-image"
                        onclick="navigateToPerson(${person.id}, '${type}')">
                    <div class="person-info">
                        <h5>${person.name}</h5>
                        <p>선호도: ${person.frequency}</p>
                    </div>
                </div>
            `;
            container.appendChild(personElement);
        });
    }

    // 사용자 선호 키워드 렌더링
    function renderKeywords(keywords, container) {
        container.innerHTML = '';

        const gridSize = Math.ceil(Math.sqrt(keywords.length));
        const cellWidth = container.offsetWidth / gridSize;
        const cellHeight = container.offsetHeight / gridSize;

        keywords.forEach((keyword, index) => {
            const span = document.createElement('span');
            span.textContent = keyword.keyword;
            span.className = 'keyword';

            const fontSize = Math.min(20, 10 + keyword.size * 2);
            span.style.fontSize = `${fontSize}px`;

            const hue = (index * 137.5) % 360; // 골든앵글을 이용한 색상 분포
            span.style.color = `hsl(${hue}, 70%, 50%)`;

            const col = index % gridSize;
            const row = Math.floor(index / gridSize);

            const left = col * cellWidth + Math.random() * (cellWidth / 2);
            const top = row * cellHeight + Math.random() * (cellHeight / 2);

            span.style.left = `${left}px`;
            span.style.top = `${top}px`;
            span.style.position = 'absolute';
            span.style.transition = 'all 0.3s ease';

            // 호버 효과 추가
            span.addEventListener('mouseover', () => {
                span.style.transform = 'scale(1.1)';
                span.style.zIndex = '10';
            });
            span.addEventListener('mouseout', () => {
                span.style.transform = 'scale(1)';
                span.style.zIndex = '1';
            });

            container.appendChild(span);
        });

        // 간단한 애니메이션 효과 추가
        setTimeout(() => {
            document.querySelectorAll('.keyword').forEach(keyword => {
                const newLeft = parseFloat(keyword.style.left) + (Math.random() - 0.5) * 20;
                const newTop = parseFloat(keyword.style.top) + (Math.random() - 0.5) * 20;
                keyword.style.left = `${newLeft}px`;
                keyword.style.top = `${newTop}px`;
            });
        }, 100);
    }


    function makeApiCall(url, method, data, successCallback) {
        $.ajax({
            url: url,
            type: method,
            data: data,
            contentType: 'application/json',
            success: successCallback,
            error: function(xhr, status, error) {
                console.error(`Error in ${method} request to ${url}:`, error);
            }
        });
    }


    function navigateToMovie(movieId) {
       window.location.href = '/contents/' + movieId;
    }

    function navigateToPerson(personId, type) {
        window.location.href = `/people/${personId}?type=${type}`;
    }
</script>